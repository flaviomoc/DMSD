---
title: "divraster-vignette"
author: "FlÃ¡vio Mota"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{divraster-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

- [Introduction](#intro)
- [Installation](#install)
- [Analysis](#analysis)

## Introduction {#intro}

Macroecological studies have been increasingly utilized in the context of climate change, necessitating the use of tools to analyze large datasets. To examine and comprehend the intricate mechanisms that underlie species distributions and the structure of biological communities, a diverse array of metrics has been developed. These metrics encompass alpha and beta diversity patterns across taxonomic (TD), functional (FD), and phylogenetic (PD) dimensions. The package [`divraster`](https://github.com/flaviomoc/divraster) addresses a current gap in this field by offering functions to calculate diversity metrics directly from rasters, eliminating the need for matrix transformations. This capability is especially valuable when dealing with extensive datasets, as matrices often impose memory constraints.

## Installation {#install}

If you find any bug, let us know through [divraster Issues](https://github.com/flaviomoc/divraster/issues). The development version of `divraster` can be installed from the [divraster repository in Github](https://github.com/flaviomoc/divraster):

```{r, eval = FALSE}
require(devtools)
devtools::install_github("flaviomoc/divraster", build_vignettes = TRUE)
```

## Analysis {#analysis}

The `divraster` package can directly calculate temporal beta diversity from multilayer rasters for taxonomic (TD), functional (FD), and phylogenetic (PD) dimensions using the `temp.beta()` function. To our knowledge this method has not been previously implemented in `R`. Furthermore, `divraster` can compute spatial alpha and beta diversity for TD, FD, and PD by using the `spat.alpha()` and `spat.beta()` functions. All beta diversity calculations are partitioned into replacement and richness differences components. Additionally, the `spat.trait()` function calculates individual average traits of continuous variables, while the `spat.rand()` calculates standardized effect size for FD and PD alpha diversity.

Let's see some examples.

# Loading data
```{r, fig.height = 5, fig.width = 8, fig.align = 'center',}
# Presence-absence SpatRaster
bin1 <- terra::rast(system.file("extdata", 
                                "ref_frugivor.tif", 
                                package = "divraster"))
bin2 <- terra::rast(system.file("extdata", 
                                "fut_frugivor.tif", 
                                package = "divraster"))

# Change extension to process faster
terra::ext(bin1)
e <- c(-41, -39, -15, -13)
bin1 <- terra::crop(bin1, e)
bin2 <- terra::crop(bin2, e)

# Species traits
traits <- read.csv(system.file("extdata", 
                               "traits_frugivor.csv", 
                               package = "divraster"), 
                   sep = ";", 
                   row.names = 1)

# Phylogenetic tree
tree <- ape::read.tree(system.file("extdata", 
                                   "tree_frugivor.tre", 
                                   package = "divraster"))
```

# Alpha diversity
```{r, fig.height = 4, fig.width = 5, fig.align = 'center',}
# Taxonomic
alpha.td <- divraster::spat.alpha(bin1)
alpha.td
terra::plot(alpha.td, main = names(alpha.td))

# Functional
alpha.fd <- divraster::spat.alpha(bin1, traits)
alpha.fd
terra::plot(alpha.fd, main = names(alpha.fd))

# Phylogenetic
alpha.pd <- divraster::spat.alpha(bin1, tree)
alpha.pd
terra::plot(alpha.pd, main = names(alpha.pd))
```

# Average traits
```{r, fig.height = 4, fig.width = 5, fig.align = 'center',}
avg.traits1 <- divraster::spat.trait(bin1, traits)
avg.traits1
terra::plot(avg.traits1, main = names(avg.traits1))
```

# Standardized Effect Size (SES)
```{r, fig.height = 4, fig.width = 5, fig.align = 'center',}
# Functional
ses.fd <- divraster::spat.rand(x = bin1, 
                               tree = traits, 
                               aleats = 3, 
                               random = "site")
ses.fd
terra::plot(ses.fd, main = names(ses.fd))

# Phylogenetic
ses.pd <- divraster::spat.rand(x = bin1, 
                               tree = tree, 
                               aleats = 3, 
                               random = "site")
ses.pd
terra::plot(ses.pd, main = names(ses.pd))
```

# Spatial beta diversity
```{r, fig.height = 4, fig.width = 5, fig.align = 'center',}
# Taxonomic
beta.td <- divraster::spat.beta(bin1)
beta.td
terra::plot(beta.td, main = names(beta.td))

# Functional
beta.fd <- divraster::spat.beta(bin1, traits)
beta.fd
terra::plot(beta.fd, main = names(beta.fd))

# Phylogenetic
beta.pd <- divraster::spat.beta(bin1, tree)
beta.pd
terra::plot(beta.pd, main = names(beta.pd))
```

# Temporal beta diversity
```{r, fig.height = 4, fig.width = 5, fig.align = 'center',}
# Taxonomic
betatemp.td <- divraster::temp.beta(bin1, bin2)
betatemp.td
terra::plot(betatemp.td, main = names(betatemp.td))

# Functional
betatemp.fd <- divraster::temp.beta(bin1, bin2, traits)
betatemp.fd
terra::plot(betatemp.fd, main = names(betatemp.fd))

# Phylogenetic
betatemp.pd <- divraster::temp.beta(bin1, bin2, tree)
betatemp.pd
terra::plot(betatemp.pd, main = names(betatemp.pd))
```
